pipeline {
    agent any
    environment {
        // Đường dẫn đến file Key.pem trên Jenkins Server (Sẽ hướng dẫn tạo ở bước sau)
        SSH_KEY_PATH = '/var/lib/jenkins/my-key.pem' 
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }
        stage('Terraform Apply') {
            steps {
                dir('infrastructure') {
                    // Khởi tạo và chạy Terraform để tạo máy
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                    
                    // Lấy IP máy vừa tạo lưu vào file
                    sh 'terraform output -raw instance_ip > server_ip.txt'
                }
            }
        }
        stage('Ansible Deploy') {
            steps {
                dir('infrastructure') {
                    script {
                        // Đọc IP từ file
                        def server_ip = readFile('server_ip.txt').trim()
                        echo "Deploying to IP: ${server_ip}"
                        
                        // Tạo file inventory tạm thời cho Ansible
                        sh "echo '[web]' > inventory.ini"
                        sh "echo '${server_ip} ansible_ssh_private_key_file=${SSH_KEY_PATH} ansible_ssh_common_args=\"-o StrictHostKeyChecking=no\"' >> inventory.ini"
                        
                        // Chờ một chút cho máy khởi động xong SSH
                        sleep 60
                        
                        // Chạy Ansible
                        sh 'ansible-playbook -i inventory.ini deploy.yml'
                    }
                }
            }
        }
    }
}
